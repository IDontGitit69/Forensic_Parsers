stages:
  - build
  - commit

process-and-deduplicate-yara:
  stage: build
  script:
    - pip3 install -r "Yara Rules/Tools/requirements.txt"
    - python3 "Yara Rules/Tools/Yaralyzer.py" -i "Yara Rules/yara_rules_raw" -o Master_Rules_List.yar -d "Yara Rules"
  artifacts:
    paths:
      - "Yara Rules/Master_Rules.yar"

commit_master_rules:
  stage: commit
  dependencies:
    - process-and-deduplicate-yara
  script:
    - git config user.name "alesher"
    - git config user.email "anthony.lesher@associates.gwe.cisa.dhs.gov"
    - git add "Yara Rules/Master_Rules.yar"
    - git commit -m "Auto-update Master_Rules.yar via CI" || echo "No changes to commit"
    - git push origin HEAD:$CI_COMMIT_REF_NAME
  tags:
    - yaralyzer
