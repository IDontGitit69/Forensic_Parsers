# ============================================================================
# YARA Rule Validation Pipeline
# ============================================================================

variables:
  PYTHON_IMAGE: "python:3.9"
  YARA_ROOT: "Yara Rules"
  NEW_RULES_DIR: "Yara Rules/New_Rules"
  BASELINE_DIR: "Yara Rules/Baseline_Rules"
  REJECTED_DIR: "Yara Rules/Rejected_Rules"
  DATABASE_PATH: "Yara Rules/database/yara_rules.db"
  REPORTS_DIR: "Yara Rules/reports"
  TEMP_DIR: "Yara Rules/temp"
  TOOLS_DIR: "Yara Rules/Tools"

stages:
  - check_baseline
  - validate_syntax
  - validate_metadata
  - deduplicate
  - integrate
  - report
  - cleanup

# ============================================================================
# Workflow Rules - Only run when there are changes in New_Rules directory
# ============================================================================
workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
      changes:
        - "Yara Rules/New_Rules/**/*"
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_PIPELINE_SOURCE == "api"'

# ============================================================================
# Reusable Configuration
# ============================================================================
.python_setup: &python_setup
  tags:
    - yara-validation
  before_script:
    - echo "üêç Setting up Python environment..."
    - pip install --quiet yara-python
    - python3 --version
    - echo "‚úÖ Python environment ready"

# ============================================================================
# STAGE 1: Baseline Check (Filter existing rules)
# ============================================================================
baseline_check:
  stage: check_baseline
  image: $PYTHON_IMAGE
  <<: *python_setup
  script:
    - echo "üîç Stage 1: Checking rules against baseline database"
    - mkdir -p "$REPORTS_DIR" "$TEMP_DIR"
    
    # Check if there are any rules to process
    - |
      RULE_COUNT=$(find "$NEW_RULES_DIR" -type f \( -name "*.yar" -o -name "*.yara" -o -name "*.rule" \) 2>/dev/null | wc -l)
      if [ "$RULE_COUNT" -eq 0 ]; then
        echo "‚ÑπÔ∏è  No YARA rules found in $NEW_RULES_DIR"
        echo "SKIP_PIPELINE=true" > pipeline.env
        exit 0
      else
        echo "üìã Found $RULE_COUNT rule file(s) to process"
        echo "SKIP_PIPELINE=false" > pipeline.env
      fi
    
    # Run baseline check
    - python3 "$TOOLS_DIR/check_baseline.py" "$NEW_RULES_DIR"
        --database "$DATABASE_PATH"
        --output-new "$TEMP_DIR/new_rules"
        --output-existing "$TEMP_DIR/already_in_baseline"
        --json-report "$REPORTS_DIR/baseline_check.json"
        --verbose
    
    # Check if we have any NEW rules to validate
    - |
      if [ -d "$TEMP_DIR/new_rules" ] && [ -n "$(ls -A $TEMP_DIR/new_rules 2>/dev/null)" ]; then
        NEW_COUNT=$(find "$TEMP_DIR/new_rules" -type f | wc -l)
        echo "‚úÖ Found $NEW_COUNT new rule(s) - proceeding to validation"
        echo "HAS_NEW_RULES=true" >> pipeline.env
      else
        echo "‚ÑπÔ∏è  No new rules to validate (all already in baseline)"
        echo "HAS_NEW_RULES=false" >> pipeline.env
      fi
    
    # Check if we have rules that are already in baseline
    - |
      if [ -d "$TEMP_DIR/already_in_baseline" ] && [ -n "$(ls -A $TEMP_DIR/already_in_baseline 2>/dev/null)" ]; then
        EXISTING_COUNT=$(find "$TEMP_DIR/already_in_baseline" -type f | wc -l)
        echo "‚è≠Ô∏è  Found $EXISTING_COUNT rule(s) already in baseline"
        echo "HAS_EXISTING_RULES=true" >> pipeline.env
        echo "EXISTING_COUNT=$EXISTING_COUNT" >> pipeline.env
      else
        echo "HAS_EXISTING_RULES=false" >> pipeline.env
        echo "EXISTING_COUNT=0" >> pipeline.env
      fi
  
  artifacts:
    paths:
      - "$TEMP_DIR/"
      - "$REPORTS_DIR/"
    reports:
      dotenv: pipeline.env
    expire_in: 1 week

# ============================================================================
# STAGE 2: Syntax Validation
# ============================================================================
validate_syntax:
  stage: validate_syntax
  image: $PYTHON_IMAGE
  <<: *python_setup
  needs:
    - job: baseline_check
      artifacts: true
      optional: true  # ‚Üê ADDED
  rules:
    - if: $HAS_NEW_RULES == "true"
  script:
    - echo "‚úÖ Stage 2: Validating YARA syntax"
    - mkdir -p "$REJECTED_DIR"
    
    - python3 "$TOOLS_DIR/validate_syntax.py" "$TEMP_DIR/new_rules"
        --output-valid "$TEMP_DIR/syntax_valid"
        --output-failed "$REJECTED_DIR"
        --json-report "$REPORTS_DIR/syntax_validation.json"
        --verbose
    
    # Check if we have any valid rules after syntax check
    - |
      if [ -d "$TEMP_DIR/syntax_valid" ] && [ -n "$(ls -A $TEMP_DIR/syntax_valid 2>/dev/null)" ]; then
        VALID_COUNT=$(find "$TEMP_DIR/syntax_valid" -type f | wc -l)
        echo "‚úÖ $VALID_COUNT rule(s) passed syntax validation"
        echo "HAS_SYNTAX_VALID=true" >> pipeline.env
      else
        echo "‚ùå No rules passed syntax validation"
        echo "HAS_SYNTAX_VALID=false" >> pipeline.env
      fi
  
  artifacts:
    paths:
      - "$TEMP_DIR/"
      - "$REJECTED_DIR/"
      - "$REPORTS_DIR/"
    reports:
      dotenv: pipeline.env
    expire_in: 1 week

# ============================================================================
# STAGE 3: Metadata Validation
# ============================================================================
validate_metadata:
  stage: validate_metadata
  image: $PYTHON_IMAGE
  <<: *python_setup
  needs:
    - job: validate_syntax
      artifacts: true
      optional: true  # ‚Üê ADDED
  rules:
    - if: $HAS_SYNTAX_VALID == "true"
  script:
    - echo "üìã Stage 3: Validating metadata"
    
    - python3 "$TOOLS_DIR/validate_metadata.py" "$TEMP_DIR/syntax_valid"
        --move-invalid "$REJECTED_DIR"
        --json-report "$REPORTS_DIR/metadata_validation.json"
        --verbose
    
    # Re-check what's still in syntax_valid (metadata check removes invalid files)
    - |
      if [ -d "$TEMP_DIR/syntax_valid" ] && [ -n "$(ls -A $TEMP_DIR/syntax_valid 2>/dev/null)" ]; then
        VALID_COUNT=$(find "$TEMP_DIR/syntax_valid" -type f | wc -l)
        echo "‚úÖ $VALID_COUNT rule(s) passed metadata validation"
        echo "HAS_METADATA_VALID=true" >> pipeline.env
      else
        echo "‚ùå No rules passed metadata validation"
        echo "HAS_METADATA_VALID=false" >> pipeline.env
      fi
  
  artifacts:
    paths:
      - "$TEMP_DIR/"
      - "$REJECTED_DIR/"
      - "$REPORTS_DIR/"
    reports:
      dotenv: pipeline.env
    expire_in: 1 week

# ============================================================================
# STAGE 4: Deduplication
# ============================================================================
deduplicate:
  stage: deduplicate
  image: $PYTHON_IMAGE
  <<: *python_setup
  needs:
    - job: validate_metadata
      artifacts: true
      optional: true  # ‚Üê ADDED
  rules:
    - if: $HAS_METADATA_VALID == "true"
  script:
    - echo "üîÑ Stage 4: Deduplicating rules"
    
    - python3 "$TOOLS_DIR/deduplicate_rules.py" "$TEMP_DIR/syntax_valid"
        --output-dir "$TEMP_DIR/deduplicated"
        --json-report "$REPORTS_DIR/deduplication.json"
        --verbose
    
    # Check if we have rules after deduplication
    - |
      if [ -d "$TEMP_DIR/deduplicated" ] && [ -n "$(ls -A $TEMP_DIR/deduplicated 2>/dev/null)" ]; then
        DEDUP_COUNT=$(find "$TEMP_DIR/deduplicated" -type f | wc -l)
        echo "‚úÖ $DEDUP_COUNT rule(s) after deduplication"
        echo "HAS_DEDUPLICATED=true" >> pipeline.env
        echo "FINAL_VALID_COUNT=$DEDUP_COUNT" >> pipeline.env
      else
        echo "‚ùå No rules remain after deduplication"
        echo "HAS_DEDUPLICATED=false" >> pipeline.env
        echo "FINAL_VALID_COUNT=0" >> pipeline.env
      fi
  
  artifacts:
    paths:
      - "$TEMP_DIR/"
      - "$REJECTED_DIR/"
      - "$REPORTS_DIR/"
    reports:
      dotenv: pipeline.env
    expire_in: 1 week

# ============================================================================
# STAGE 5: Database Update & Integration
# ============================================================================
integrate:
  stage: integrate
  image: $PYTHON_IMAGE
  <<: *python_setup
  needs:
    - job: deduplicate
      artifacts: true
      optional: true  # ‚Üê ADDED
  rules:
    - if: $SKIP_PIPELINE != "true"
  script:
    - echo "üíæ Stage 5: Updating database and integrating rules"
    
    # Update database if we have validated rules
    - |
      if [ "$HAS_DEDUPLICATED" = "true" ]; then
        echo "üìä Updating baseline database..."
        python3 "$TOOLS_DIR/update_database.py" "$TEMP_DIR/deduplicated"
            --database "$DATABASE_PATH"
            --json-report "$REPORTS_DIR/database_update.json"
            --verbose
        
        echo "üìÅ Moving validated rules to baseline..."
        mkdir -p "$BASELINE_DIR"
        cp -v "$TEMP_DIR/deduplicated"/* "$BASELINE_DIR/" || echo "No files to copy"
      else
        echo "‚ÑπÔ∏è  No rules to add to database"
        # Create empty report
        echo '{"statistics": {"total_added": 0, "total_skipped": 0}, "added_rules": [], "skipped_rules": []}' > "$REPORTS_DIR/database_update.json"
      fi
  
  artifacts:
    paths:
      - "$BASELINE_DIR/"
      - "$REJECTED_DIR/"
      - "$REPORTS_DIR/"
      - "$DATABASE_PATH"
    reports:
      dotenv: pipeline.env
    expire_in: 1 week

# ============================================================================
# STAGE 6: Generate Comprehensive Report
# ============================================================================
generate_report:
  stage: report
  image: $PYTHON_IMAGE
  <<: *python_setup
  needs:
    - job: integrate
      artifacts: true
      optional: true  # ‚Üê ADDED
  rules:
    - if: $SKIP_PIPELINE != "true"
  script:
    - echo "üìä Stage 6: Generating comprehensive validation report"
    
    - python3 "$TOOLS_DIR/generate_report.py"
        --baseline "$REPORTS_DIR/baseline_check.json"
        --syntax "$REPORTS_DIR/syntax_validation.json"
        --metadata "$REPORTS_DIR/metadata_validation.json"
        --dedup "$REPORTS_DIR/deduplication.json"
        --database "$REPORTS_DIR/database_update.json"
        --output-json "$YARA_ROOT/validation_report.json"
        --output-markdown "$YARA_ROOT/validation_report.md"
    
    - echo "‚úÖ Reports generated successfully"
    - echo ""
    - echo "üìÑ Master Reports:"
    - echo "  - $YARA_ROOT/validation_report.json"
    - echo "  - $YARA_ROOT/validation_report.md"
  
  artifacts:
    paths:
      - "$YARA_ROOT/validation_report.json"
      - "$YARA_ROOT/validation_report.md"
      - "$REPORTS_DIR/"
      - "$BASELINE_DIR/"
      - "$REJECTED_DIR/"
      - "$DATABASE_PATH"
    expire_in: 1 week

# ============================================================================
# STAGE 7: Cleanup and Commit
# ============================================================================
commit_changes:
  stage: cleanup
  image: $PYTHON_IMAGE
  tags:
    - yara-validation
  needs:
    - job: generate_report
      artifacts: true
      optional: true  # ‚Üê ADDED
  rules:
    - if: $SKIP_PIPELINE != "true"
  script:
    - echo "üßπ Stage 7: Cleaning up and committing changes"
    
    # Configure Git
    - echo "üîß Configuring Git..."
    - git config --global user.email "${user_email}"
    - git config --global user.name "${user_name}"
    - git config --global http.sslCAInfo "${SSL_CERT_FILE_PATH}"
    - git remote set-url origin https://alesher:${PAT_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
    
    # Fetch latest changes
    - echo "‚¨áÔ∏è  Fetching latest changes..."
    - git fetch origin $CI_COMMIT_REF_NAME
    
    # Check if we're behind
    - |
      BEHIND=$(git rev-list --count HEAD..origin/$CI_COMMIT_REF_NAME)
      if [ "$BEHIND" -gt 0 ]; then
        echo "‚ö†Ô∏è  Branch is $BEHIND commit(s) behind origin"
        echo "üîÑ Resetting to origin state..."
        git reset --hard origin/$CI_COMMIT_REF_NAME
      else
        echo "‚úÖ Branch is up to date with origin"
      fi
    
    # Remove processed rules from New_Rules directory
    - echo "üóëÔ∏è  Removing processed rules from $NEW_RULES_DIR..."
    - |
      REMOVED_COUNT=0
      if [ -d "$NEW_RULES_DIR" ]; then
        for file in "$NEW_RULES_DIR"/*.yar "$NEW_RULES_DIR"/*.yara "$NEW_RULES_DIR"/*.rule; do
          if [ -f "$file" ]; then
            echo "  Removing: $(basename $file)"
            git rm -f "$file" 2>/dev/null || rm -f "$file"
            REMOVED_COUNT=$((REMOVED_COUNT + 1))
          fi
        done
      fi
      echo "üóëÔ∏è  Removed $REMOVED_COUNT file(s) from $NEW_RULES_DIR"
    
    # Stage all changes
    - echo "üìù Staging changes..."
    - git add "$BASELINE_DIR/" || true
    - git add "$REJECTED_DIR/" || true
    - git add "$DATABASE_PATH" || true
    - git add "$REPORTS_DIR/" || true
    - git add "$YARA_ROOT/validation_report.json" || true
    - git add "$YARA_ROOT/validation_report.md" || true
    - git add "$NEW_RULES_DIR/" || true
    
    # Show what we're committing
    - echo "üìã Changes to commit:"
    - git status --short
    
    # Create commit message
    - |
      ADDED_COUNT=${FINAL_VALID_COUNT:-0}
      EXISTING=${EXISTING_COUNT:-0}
      
      # Count rejected files
      REJECTED_COUNT=0
      if [ -d "$REJECTED_DIR" ]; then
        REJECTED_COUNT=$(find "$REJECTED_DIR" -type f \( -name "*.yar" -o -name "*.yara" -o -name "*.rule" \) 2>/dev/null | wc -l)
      fi
      
      # Build commit message
      if [ "$ADDED_COUNT" -gt 0 ] && [ "$REJECTED_COUNT" -gt 0 ]; then
        COMMIT_MSG="CI: Processed YARA rules - Added: ${ADDED_COUNT}, Rejected: ${REJECTED_COUNT}"
      elif [ "$ADDED_COUNT" -gt 0 ]; then
        COMMIT_MSG="CI: Successfully added ${ADDED_COUNT} YARA rule(s)"
      elif [ "$REJECTED_COUNT" -gt 0 ]; then
        COMMIT_MSG="CI: Rejected ${REJECTED_COUNT} YARA rule(s)"
      elif [ "$EXISTING" -gt 0 ]; then
        COMMIT_MSG="CI: All ${EXISTING} rule(s) already in baseline"
      else
        COMMIT_MSG="CI: Processed YARA rules"
      fi
      
      # Add skip ci flag
      COMMIT_MSG="${COMMIT_MSG} [skip ci]"
      
      echo "üí¨ Commit message: $COMMIT_MSG"
    
    # Commit if there are changes
    - |
      if git diff --cached --quiet; then
        echo "‚ÑπÔ∏è  No changes to commit"
      else
        echo "üíæ Creating commit..."
        git commit -m "$COMMIT_MSG"
        
        echo "üì§ Pushing changes to repository..."
        git push origin HEAD:${CI_COMMIT_REF_NAME}
        
        echo "‚úÖ Successfully pushed changes to ${CI_COMMIT_REF_NAME}"
      fi
    
    - echo ""
    - echo "="*80
    - echo "‚úÖ PIPELINE COMPLETED SUCCESSFULLY"
    - echo "="*80
    - |
      echo "üìä Summary:"
      echo "  - Rules Added: ${FINAL_VALID_COUNT:-0}"
      echo "  - Rules Rejected: ${REJECTED_COUNT:-0}"
      echo "  - Already in Baseline: ${EXISTING_COUNT:-0}"
      echo ""
      echo "üìÑ View comprehensive report: $YARA_ROOT/validation_report.md"
      echo "="*80
  
  allow_failure: false
