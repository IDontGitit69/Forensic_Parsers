validate_yara_rules:
  stage: validate
  rules:
    - changes:
        - "$NEW_RULES_DIR/**"
      when: on_success
    - when: never
  image: $PYTHON_IMAGE
  <<: *python_setup
  script:
    - echo "üîç Validating YARA rules in $NEW_RULES_DIR"
    - |
      python3 "Yara Rules/Tools/Yaralyzer.py" "$NEW_RULES_DIR" \
        --output-valid-dir "$VALIDATED_DIR" \
        --output-failed-dir "$FAILED_DIR" \
        --json-report "$JSON_REPORT" \
        --markdown-report "$MD_REPORT" \
        --deduplicate \
        --verbose \
        --require-metadata
    
    # NEW: Clean up processed files from NEW_RULES_DIR
    - echo "üßπ Cleaning up processed files from $NEW_RULES_DIR"
    - |
      if [ -d "$VALIDATED_DIR" ] && [ -n "$(ls -A "$VALIDATED_DIR" 2>/dev/null)" ]; then
        echo "‚úÖ Removing validated files from $NEW_RULES_DIR"
        for file in "$VALIDATED_DIR"/*.{yar,yara,rule}; do
          [ -f "$file" ] || continue
          basename_file=$(basename "$file")
          # Remove the original file from NEW_RULES_DIR if it exists
          [ -f "$NEW_RULES_DIR/$basename_file" ] && rm -f "$NEW_RULES_DIR/$basename_file"
        done
      fi
      
      if [ -d "$FAILED_DIR" ] && [ -n "$(ls -A "$FAILED_DIR" 2>/dev/null)" ]; then
        echo "‚ùå Removing failed files from $NEW_RULES_DIR"
        for file in "$FAILED_DIR"/*.{yar,yara,rule}; do
          [ -f "$file" ] || continue
          basename_file=$(basename "$file")
          # Remove the original file from NEW_RULES_DIR if it exists
          [ -f "$NEW_RULES_DIR/$basename_file" ] && rm -f "$NEW_RULES_DIR/$basename_file"
        done
      fi
    
    - echo "üìä Remaining files in $NEW_RULES_DIR:"
    - ls -la "$NEW_RULES_DIR" || echo "Directory empty or not found"

  artifacts:
    when: always
    paths:
      - $VALIDATED_DIR/
      - $FAILED_DIR/
      - $JSON_REPORT
      - $MD_REPORT
    expire_in: 7 days

  allow_failure: true
