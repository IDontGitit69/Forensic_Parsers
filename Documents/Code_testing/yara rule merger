#!/usr/bin/env python3
import sys, re

def extract_rules(filename):
    with open(filename, 'r') as f:
        content = f.read()
    # Split on YARA 'rule ' or Sigma 'title: '
    rules = re.split(r'(?=^rule\s|\ntitle:\s)', content, flags=re.MULTILINE)
    return [r.strip() for r in rules if r.strip()]

def merge_rules(file1, file2, outfile):
    seen = set()
    merged = []
    for f in (file1, file2):
        for rule in extract_rules(f):
            if rule not in seen:
                seen.add(rule)
                merged.append(rule)
    with open(outfile, 'w') as out:
        out.write("\n\n".join(merged))

if __name__ == "__main__":
    if len(sys.argv) != 4:
        print("Usage: merge_rules.py file1 file2 merged_file")
        sys.exit(1)
    merge_rules(sys.argv[1], sys.argv[2], sys.argv[3])
