# ==============================================================================
# STAGE 2: PUSH
# ==============================================================================
push_to_repo:
  stage: push
  needs:
    - job: validate_yara_rules
      artifacts: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'
      changes:
        - "$NEW_RULES_DIR/**"
      when: on_success
  script:
    - echo "üì§ Pushing validation results to repository"
    
    # Verify we have artifacts to push
    - |
      FILES_TO_PUSH=0
      [ -f "$JSON_REPORT" ] && FILES_TO_PUSH=$((FILES_TO_PUSH + 1))
      [ -f "$MD_REPORT" ] && FILES_TO_PUSH=$((FILES_TO_PUSH + 1))
      [ -d "$VALIDATED_DIR" ] && [ -n "$(ls -A "$VALIDATED_DIR" 2>/dev/null)" ] && FILES_TO_PUSH=$((FILES_TO_PUSH + 1))
      if [ $FILES_TO_PUSH -eq 0 ]; then
        echo "‚ö†Ô∏è  No files to push (validation may have failed or produced no output)"
        exit 0
      fi
      echo "‚úÖ Found $FILES_TO_PUSH artifact(s) to push"
    
    # Configure Git
    - git config --global user.email "${user_email}"
    - git config --global user.name "${user_name}"
    - git config --global http.sslcainfo "${SSL_CERT_FILE_PATH}"
    - git remote set-url origin https://alesher:${PAT_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
    
    # Pull latest changes to avoid conflicts
    - git pull origin $CI_COMMIT_REF_NAME --rebase || true
    
    # ========================================================================
    # üÜï NEW: Remove processed files from NEW_RULES_DIR and stage deletions
    # ========================================================================
    - echo "üóëÔ∏è Removing processed files from $NEW_RULES_DIR"
    - |
      # Track how many files we remove
      REMOVED_COUNT=0
      
      # Remove validated files from NEW_RULES_DIR
      if [ -d "$VALIDATED_DIR" ] && [ -n "$(ls -A "$VALIDATED_DIR" 2>/dev/null)" ]; then
        echo "‚úÖ Processing validated files..."
        for file in "$VALIDATED_DIR"/*; do
          [ -f "$file" ] || continue
          
          # Extract the original source filename from the header comment
          original_name=$(grep "^// Source:" "$file" 2>/dev/null | sed 's/^.*\///' | head -1)
          
          # If we can't find it in the header, fall back to the basename (strip _N suffixes)
          if [ -z "$original_name" ]; then
            basename_file=$(basename "$file")
            # Remove _1, _2, _3, etc. suffixes before extension
            original_name=$(echo "$basename_file" | sed 's/_[0-9]\+\(\.[^.]*\)$/\1/')
          fi
          
          source_file="$NEW_RULES_DIR/$original_name"
          
          if [ -f "$source_file" ]; then
            echo "  üóëÔ∏è  Removing validated: $original_name"
            git rm -f "$source_file" 2>/dev/null || rm -f "$source_file"
            REMOVED_COUNT=$((REMOVED_COUNT + 1))
          fi
        done
      fi
      
      # Remove failed files from NEW_RULES_DIR
      if [ -d "$FAILED_DIR" ] && [ -n "$(ls -A "$FAILED_DIR" 2>/dev/null)" ]; then
        echo "‚ùå Processing failed files..."
        for file in "$FAILED_DIR"/*; do
          [ -f "$file" ] || continue
          
          # Extract the original source filename from the header comment
          original_name=$(grep "^// Source:" "$file" 2>/dev/null | sed 's/^.*\///' | head -1)
          
          # If we can't find it in the header, fall back to the basename (strip _N suffixes)
          if [ -z "$original_name" ]; then
            basename_file=$(basename "$file")
            # Remove _1, _2, _3, etc. suffixes before extension
            original_name=$(echo "$basename_file" | sed 's/_[0-9]\+\(\.[^.]*\)$/\1/')
          fi
          
          source_file="$NEW_RULES_DIR/$original_name"
          
          if [ -f "$source_file" ]; then
            echo "  üóëÔ∏è  Removing failed: $original_name"
            git rm -f "$source_file" 2>/dev/null || rm -f "$source_file"
            REMOVED_COUNT=$((REMOVED_COUNT + 1))
          fi
        done
      fi
      
      echo "üìä Total files removed from $NEW_RULES_DIR: $REMOVED_COUNT"
    # ========================================================================
    # END NEW SECTION
    # ========================================================================
    
    # Stage files
    - git add "$VALIDATED_DIR/" || true
    - git add "$FAILED_DIR/" || true
    - git add "$JSON_REPORT" || true
    - git add "$MD_REPORT" || true
    - git add "$NEW_RULES_DIR/" || true
    
    # Show what we're committing
    - echo "üìù Files to be committed:"
    - git status --short
    
    # Commit and push (exit gracefully if nothing to commit)
    - git commit -m "CI: Add validated YARA rules and reports [skip ci]" || (echo "Nothing to commit" && exit 0)
    - git push origin HEAD:${CI_COMMIT_REF_NAME}
    - echo "‚úÖ Successfully pushed to ${CI_COMMIT_REF_NAME}"
  
  allow_failure: true
